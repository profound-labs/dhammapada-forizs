\ProvidesPackage{mylayout}

%% ===========================
%% Packages to be loaded FIRST
%% ===========================

\usepackage[hungarian]{babel}

\usepackage{nag}
\usepackage{calc}
\usepackage{xparse}
\usepackage{soul}
\usepackage{textcomp}
%\usepackage{booktabs}
\usepackage{longtable}
\usepackage{ifthen}
\usepackage[cmyk]{xcolor}

\usepackage[pdftex]{graphicx}
\graphicspath{{./src-images/}}
\usepackage{eso-pic}
\usepackage{ccicons}

\usepackage{tikz}

%% =============
%% Define colors
%% =============

\definecolor{textbody}{gray}{0.1}
\definecolor{drop}{gray}{0.7}
\definecolor{capsline}{gray}{0.3}
\definecolor{chapnum}{gray}{0.5}
\definecolor{chaptitle}{gray}{0.3}
\definecolor{chapsubtitle}{gray}{0.6}
\definecolor{footnoterule}{gray}{0.5}

%% ============================
%% Load fonts (before multicol)
%% ============================

\usepackage{fontspec}
\setmainfont
[ Ligatures = TeX,
  BoldFont = Crimson Semibold,
  ItalicFont = TeX Gyre Pagella Italic,
  ItalicFeatures = { Ligatures = TeX, Scale = 0.9 } ]
{Crimson Roman}

\newfontfamily\oldNumFont[Ligatures = TeX, Numbers = OldStyle]{Crimson Roman}

\newfontfamily\dropFont[Ligatures = TeX]{Arno Pro Light Display}

\newfontfamily\chapTitleFont[Ligatures = TeX]{Arno Pro}
\newfontfamily\chapNameFont[Ligatures = TeX]{Arno Pro}
\newfontfamily\chapNumFont[Ligatures = TeX]{Arno Pro}

\newfontfamily\sectionFont[Ligatures = TeX]{Arno Pro}

\newfontfamily\headFont[Ligatures = TeX]{Arno Pro}
\newfontfamily\footFont[Ligatures = TeX]{Gentium}

% lettrineFirstLetter
% lettrineWords

\newfontfamily\tocPageNumFont[Ligatures = TeX]{Gentium}

% \addfontfeature{Kerning = Uppercase}

%% ===========================================
%% Set font sizes, indentation, etc.
%% ===========================================

\setlength{\parindent}{1em}

\setlength{\vgap}{1.5em}
\setlength{\vindent}{\vgap}
% for the verse env., used in the text
\setlength{\vleftmargin}{2em}
\newdimen\vrightmargin
\setlength{\vrightmargin}{2em}

% for the dhpverse env., used for the verses, alternating the margin
% depending on whether the env. begins on recto or verso
\newlength\verseOddOuterMargin
\setlength{\verseOddOuterMargin}{5mm}
\newlength\verseOddInnerMargin
\setlength{\verseOddInnerMargin}{20mm}
\newlength\verseEvenOuterMargin
\setlength{\verseEvenOuterMargin}{5mm}
\newlength\verseEvenInnerMargin
\setlength{\verseEvenInnerMargin}{15mm}

\renewcommand{\normalsize}{%
   \@setfontsize\normalsize\@xipt{16}%
   \abovedisplayskip 11\p@ \@plus3\p@ \@minus6\p@
   \abovedisplayshortskip \z@ \@plus3\p@
   \belowdisplayshortskip 6.5\p@ \@plus3.5\p@ \@minus3\p@
   \belowdisplayskip \abovedisplayskip
   \color{textbody}
   \let\@listi\@listI}
\normalsize

\newcommand{\smaller}{\@setfontsize\smaller{9}{11}}

\newcommand{\chapnamesize}{\@setfontsize\chapnamesize{22}{24}}
\newcommand{\chaptitlesize}{\@setfontsize\chaptitlesize{13}{20}}

\newcommand{\sectiontitlesize}{\@setfontsize\sectiontitlesize{11.5}{18}}

%% ==============================
%% Packages that come AFTER fonts
%% ==============================

\usepackage{multicol}

\usepackage{lettrine}

\setcounter{DefaultLines}{3}
\renewcommand{\DefaultLoversize}{0.15}
\renewcommand{\DefaultLraise}{0}
\renewcommand{\DefaultLhang}{0.4}
\renewcommand{\LettrineFontHook}{\dropFont\color{drop}}
\renewcommand{\LettrineTextFont}{\scshape\color{capsline}}

%% ============================
%% Set page geometry and layout
%% ============================

%% blurb.com pocket size:
%% 5.125 x 8.25 in
%% 369 x 594 pt

%% Use inches! Using pt somehow produces a pdf that blurb.com recognizes as different size.
\usepackage{geometry}
\geometry{
paperwidth=5.125in,
paperheight=8.25in,
outer=15mm,
inner=17mm,
marginparwidth=8mm,
marginparsep=2mm,
top=20mm,
bottom=25mm,
%showframe
}
\setstocksize{8.25in}{5.125in}
%\settrimmedsize{8.25in}{125mm}{*}
%\settrims{0pt}{\stockwidth - \paperwidth}
%\setlrmarginsandblock{15mm}{17mm}{*}
%\setulmarginsandblock{20mm}{25mm}{*}

%\setlength{\stockwidth}{5.125in}
%\setlength{\stockheight}{8.25in}
%\setlength{\trimedge}{\stockwidth}
%\addtolength{\trimedge}{-\paperwidth}

%\addtolength{\textheight}{3\baselineskip}
%\addtolength{\headheight}{5pt}
%\addtolength{\topmargin}{-1.5\baselineskip}
%\addtolength{\headsep}{0.5\baselineskip}
%\addtolength{\footskip}{0.5\baselineskip}

\setlength{\marginparpush}{0.8\baselineskip}
%\setmarginnotes{2mm}{8mm}{0.8\baselineskip}

%\checkandfixthelayout

%% ========
%% Hyperref
%% ========

\usepackage{hyperref}
\hypersetup{
  colorlinks=true,
  unicode=true,
  linkcolor=textbody,
  citecolor=textbody,
  filecolor=textbody,
  urlcolor=textbody
}
\usepackage[
  open,
  openlevel=2
]{bookmark}

%% =========
%% Penalties
%% =========
%%
%% default values (using memoir, without \midsloppy):
%% \pretolerance 100
%% \tolerance 200
%% \hyphenpenalty 50
%% \exhyphenpenalty 50
%% \doublehyphendemerits 10000
%% \finalhyphendemerits 5000
%% \brokenpenalty 100
%% \clubpenalty 1000
%% \widowpenalty 1000
%% \hbadness 1000
%% \emergencystretch 0.0pt
%% \hfuzz 0.1pt
%% \vfuzz 0.1pt
%% \parfillskip 0.0pt plus 1.0fil
%%
%% After \midsloppy:
%% \tolerance 5000
%% \hbadness 4000
%% \emergencystretch 1.5em
%% \hfuzz .1\p@
%% \vfuzz\hfuzz

% memoir can use more allowing penalties
\midsloppy

%\usepackage[defaultlines=2,all]{nowidow}

% manually adjust the penalties:

%% Make hyphenation less frequent
%% WARNING: there will be more underfull lines, and some very streched
%% lines. Check the log file for underfull warnings.

% \lefthyphenmin=3
% \righthyphenmin=3
% 
% \hyphenpenalty=600
% \exhyphenpenalty=50
% \doublehyphendemerits=900
% \brokenpenalty=990

%% =============
%% soul settings
%% =============

\sodef\soTocChapter{}{.1em}{.5em plus.1em}{.1em plus.1em minus.1em}
\sodef\soSection{}{.1em}{.5em plus.1em}{.1em plus.1em minus.1em}
\sodef\soChapter{}{.1em}{.5em plus.1em}{.1em plus.1em minus.1em}
\sodef\soDropcapsA{}{.1em}{.3em plus.1em}{.4em plus.1em minus.1em}
\sodef\soDropcapsB{}{.1em}{.3em plus.1em}{.4em plus.1em minus.1em}

%% =====================================
%% New, custom commands and environments
%% =====================================

\newcommand*{\subtitle}[1]{\def\@thesubtitle{#1}}
\newcommand*{\editionInfo}[1]{\def\@theEditionInfo{#1}}
\newcommand*{\ISBN}[1]{\def\@theISBN{#1}}

\newcommand\thesubtitle{\@thesubtitle}
\newcommand\theEditionInfo{\@theEditionInfo}
\newcommand\theISBN{\@theISBN}

\newsavebox{\quotepagebox}
\newenvironment{quotepage}[1]
  {\begin{lrbox}{\quotepagebox}\begin{minipage}{#1}
   \setlength{\parskip}{0.6\baselineskip}
   \setlength{\parindent}{0pt}}
  {\end{minipage}\end{lrbox}%
   \clearpage\thispagestyle{empty}
   \begin{tikzpicture}[remember picture,overlay]  
   \node at (current page.center) {\usebox{\quotepagebox}};
   \end{tikzpicture}
   \clearpage}

\newenvironment{packeditemize}%
{\begin{itemize}%
  \setlength{\itemsep}{1pt}%
  \setlength{\parskip}{0pt}%
  \setlength{\parsep}{0pt}%
}{\end{itemize}}

\def\gobble@spaces{\@ifnextchar\space{\@gobble\gobble@spaces}{}}
%\newcommand{\verseref}[1]{\mbox{}\marginpar{\par\vspace*{-7pt}\oldNumFont #1.}\gobble@spaces}
\newcommand{\verseref}[1]{\mbox{}\marginpar{\vspace*{-0.5\marginparpush}\vspace*{1.2pt}\oldNumFont #1.}\gobble@spaces}
\newcommand{\firstverseref}[2][0pt]{\marginpar{\vspace*{#1}\oldNumFont #2.}}

\newlength\yshiftvref

\newenvironment{firstdhpverse}[2][0pt]{%
\setlength\yshiftvref{-22pt + #1}
\noindent
\firstverseref[\yshiftvref]{#2}
\hspace*{\verseOddInnerMargin}
\begin{minipage}{85mm}
\noindent}
{\end{minipage}
\vspace*{-\baselineskip}\vspace*{\vgap}\vspace*{0.5mm}}

\renewenvironment{verse}[1][\linewidth]{%
  \refstepcounter{verse}%
  \setcounter{poemline}{0}\refstepcounter{poemline}%
  \setcounter{vslineno}{1}%
  \let\\=\@vscentercr
  \list{}{\itemsep     \z@
          \itemindent  -\vindent
          \listparindent\itemindent
          \leftmargin   \vleftmargin
          \parsep       \stanzaskip
          \ifdim #1<\linewidth%   %% short line
            \rightmargin        \z@
            \leftmargin         \linewidth
            \advance\leftmargin -#1\relax
            \advance\leftmargin -0.5\leftmargin
            \advance\leftmargin \vindent
          \else
            \ifdim #1>\linewidth%  %% long line
              \rightmargin \z@
              \leftmargin  \vindent
            \else%                   %% default
              \rightmargin \vrightmargin
              \advance\leftmargin \vindent
            \fi
          \fi}
  \item[]}{\endlist}

\newlength\dhpvleftm
\newlength\dhpvrightm

\newenvironment{dhpverse}[1][\linewidth]{%
  \ifthenelse{\isodd{\thepage}}%
  {\setlength{\dhpvleftm}{\verseOddInnerMargin}%
   \setlength{\dhpvrightm}{\verseOddOuterMargin}}%
  {\setlength{\dhpvleftm}{\verseEvenOuterMargin}%
   \setlength{\dhpvrightm}{\verseEvenInnerMargin}}%
  \refstepcounter{verse}%
  \setcounter{poemline}{0}\refstepcounter{poemline}%
  \setcounter{vslineno}{1}%
  \let\\=\@vscentercr
  \list{}{\itemsep     \z@
          \itemindent  -\vindent
          \listparindent\itemindent
          \leftmargin   \dhpvleftm
          \parsep       \stanzaskip
          \ifdim #1<\linewidth%   %% short line
            \rightmargin        \z@
            \leftmargin         \linewidth
            \advance\leftmargin -#1\relax
            \advance\leftmargin -0.5\leftmargin
            \advance\leftmargin \vindent
          \else
            \ifdim #1>\linewidth%  %% long line
              \rightmargin \z@
              \leftmargin  \vindent
            \else%                   %% default
              \rightmargin \dhpvrightm
              \advance\leftmargin \vindent
            \fi
          \fi}
  \item[]}{\endlist}

\newcommand\emptysheet{%
  \cleardoublepage
  \thispagestyle{empty}\mbox{}\newpage
  \thispagestyle{empty}\mbox{}\newpage
}

\newcommand{\pali}[1]{\textit{#1}}
\newcommand{\suttaref}[1]{\hspace*{\fill}\footnotesize\begingroup #1 \endgroup\par}
\newcommand{\attrib}[1]{\nopagebreak{\raggedleft\footnotesize #1\par}}

\def\@vaggaName{}
\newcommand*{\setVaggaName}[1]{\def\@vaggaName{#1}}

\newcommand*{\chapterVagga}[2]{%
  \setVaggaName{\MakeLowercase{#2}}%
  \chapter{#1}%
  \markboth{#1}{#2}%
}

\newenvironment{notesdescription}%
               {\list{}{\labelwidth\z@
                        \itemindent-\leftmargin
                        \let\makelabel\notesdesc}}%
               {\endlist}
\newcommand*{\notesdesc}[1]{\notesdescriptionlabel #1}
\newcommand*{\notesdescriptionlabel}[3]{\hspace\labelsep
{\normalfont
{\small v}\space\textperiodcentered\space
{\oldNumFont #1}}\space\textperiodcentered\space
\textit{#2}\space\textperiodcentered\space \textit{#3}}

\newcommand{\addNotesFile}[1]{
\newpage
\thispagestyle{plain}
%\restoregeometry
\loadgeometry{notes}
\Section{Jegyzetek}
\vspace*{\baselineskip}
\input{#1}
%\newpage
\loadgeometry{verses}
}

%% =======================
%% Renewing package macros
%% =======================

\renewcommand\notesname{Jegyzetek}
\renewcommand*{\contentsname}{Tartalom}
\renewcommand*{\bookname}{Könyv}
\renewcommand*{\partname}{Rész}
\renewcommand*{\chaptername}{Fejezet}
\renewcommand*{\indexname}{Mutató}
\renewcommand*{\pagename}{oldal}
\renewcommand*{\pagerefname}{oldal}
\renewcommand*{\bookrefname}{Könyv~}
\renewcommand*{\partrefname}{Rész~}
\renewcommand*{\chapterrefname}{Fejezet~}

\renewcommand*{\notedivision}{\section*{\notesname}}
\renewcommand*{\pagenotesubhead}[3]{}
\renewcommand*{\notenumintext}[1]{\textsuperscript{\thinspace [#1]}}
\renewcommand{\prenoteinnotes}{\par\noindent}
\renewcommand{\postnoteinnotes}{\par\vspace*{0.5\baselineskip}}

\renewcommand\footnoterule{%
  \vspace*{\baselineskip}%
  \kern-3\p@
  {\color{footnoterule}\hrule height 0.1pt width \columnwidth}
  \kern2.6\p@}

%% ===========
%% Page styles
%% ===========

\makepagestyle{normalpage}
  \makepsmarks{normalpage}{%
    \def\chaptermark##1{\markboth{\memUChead{##1}}{}}%
    \def\tocmark{\markboth{\memUChead{\contentsname}}{\memUChead{\contentsname}}}%
    \def\lofmark{\markboth{\memUChead{\listfigurename}}{\memUChead{\listfigurename}}}%
    \def\lotmark{\markboth{\memUChead{\listtablename}}{\memUChead{\listtablename}}}%
    \def\bibmark{\markboth{\memUChead{\bibname}}{\memUChead{\bibname}}}%
    \def\indexmark{\markboth{\memUChead{\indexname}}{\memUChead{\indexname}}}%
    \def\sectionmark##1{\markright{\memUChead{##1}}}}
  \makepsmarks{normalpage}{%
    \nouppercaseheads
    \createmark{chapter}{left}{nonumber}{}{}
    \createmark{section}{right}{nonumber}{}{}
    \createplainmark{toc}{both}{\contentsname}
    \createplainmark{lof}{both}{\listfigurename}
    \createplainmark{lot}{both}{\listtablename}
    \createplainmark{bib}{both}{\bibname}
    \createplainmark{index}{both}{\indexname}
    \createplainmark{glossary}{both}{\glossaryname}
  }
  \makeevenhead{normalpage}{}{\small\itshape\leftmark}{}
  \makeoddhead{normalpage}{}{\small\itshape\rightmark}{}
  \makeevenfoot{normalpage}{}{\thepage}{}
  \makeoddfoot{normalpage}{}{\thepage}{}

\pagestyle{normalpage}

%% ============
%% TOC settings
%% ============

\newlength{\toctopskip}
\setlength{\toctopskip}{2\baselineskip}

\renewcommand{\printtoctitle}[1]{%
  \raggedright\vspace*{\toctopskip}%
  \hspace*{17pt}\parbox{0.85\linewidth}{%
    \raggedright\chapTitleFont\chaptitlesize\MakeUppercase{\soChapter{\contentsname}}%
  }%
}

\renewcommand{\cftchapterfont}{\chapTitleFont\chaptitlesize\color{chaptitle}}
\renewcommand{\cftchapterpagefont}{\tocPageNumFont\normalsize\color{chaptitle}}
\renewcommand{\cftchapterpresnum}[1]{}
\setlength{\cftchapternumwidth}{0pt}
\renewcommand{\chapternumberline}[1]{}

\setlength{\cftbeforechapterskip}{0.9em \@plus\p@}

\renewcommand{\cftsectiondotsep}{\cftnodots}
\renewcommand{\cftsectionpresnum}[1]{}
\setlength{\cftsectionnumwidth}{0pt}
\renewcommand{\numberline}[1]{}

\renewcommand{\cftsubsectiondotsep}{\cftnodots}
\renewcommand{\cftsubsectionpresnum}[1]{}
\setlength{\cftsubsectionnumwidth}{0pt}

%% ====================
%% Part and Book styles
%% ====================

\aliaspagestyle{book}{empty}
\aliaspagestyle{part}{empty}

\renewcommand*{\printbookname}{}
\renewcommand*{\printbooknum}{}

\renewcommand*{\booktitlefont}{\chapNameFont\chaptitlesize\color{chaptitle}}
\renewcommand*{\printbooktitle}[1]{\booktitlefont\MakeUppercase{\soChapter{#1}}}
\renewcommand*{\afterbookskip}{\vfil}

\renewcommand{\partnamefont}{\booktitlefont}
\renewcommand{\partnumfont}{\booktitlefont}
\renewcommand{\parttitlefont}{\booktitlefont}
\renewcommand{\printpartname}{\partnamefont\MakeUppercase{\soChapter{\partname}}}

\renewcommand{\printparttitle}[1]{\parttitlefont\MakeUppercase{\soChapter{#1}}}

%% ==============
%% Chapter styles
%% ==============

\setsecnumdepth{chapter}

\makechapterstyle{frontmatter}{%
  \chapterstyle{default}
  \setlength{\beforechapskip}{18mm}
  \addtolength{\beforechapskip}{-4\baselineskip}
  \setlength{\midchapskip}{2\baselineskip}
  \setlength{\afterchapskip}{2em}
  \renewcommand*{\chapnumfont}{\chapNumFont\chapnamesize}
  \renewcommand*{\chapnamefont}{\chapNameFont}
  \renewcommand*{\chaptitlefont}{\chapTitleFont\chaptitlesize}
  \renewcommand*{\printchaptername}{}
  \renewcommand*{\printchapternum}{\chapnumfont\color{chapnum}\raggedright\hspace*{17pt}\thechapter}
  \renewcommand*{\printchapternonum}{\chapnumfont\mbox{}\afterchapternum}
  \renewcommand*{\printchaptertitle}[1]{%
    \raggedright\hspace*{17pt}\parbox{0.85\linewidth}{\raggedright\chaptitlefont\color{chaptitle}\MakeUppercase{\soChapter{##1}}}}
}

\makechapterstyle{backmatter}{%
  \chapterstyle{frontmatter}%
  \printchapternonum%
}

\newdimen\chapheadindent
\setlength{\chapheadindent}{2em}

\makechapterstyle{versechapter}{%
  \chapterstyle{default}
  \setlength{\beforechapskip}{30pt}
  \setlength{\afterchapskip}{70pt}
  \setlength{\midchapskip}{15pt}
  \renewcommand*\printchaptername{}
  \renewcommand*\printchapternum{}
  \renewcommand*\afterchapternum{}
  \renewcommand*\chapnumfont{\HUGE\color{chapnum}}
  \renewcommand*\chaptitlefont{\normalfont\Large\color{chaptitle}}
  \newcommand*\chapsubtitlefont{\normalfont\itshape\large\color{chapsubtitle}}
  \renewcommand\printchaptertitle[1]{%
    \centering%
    \chaptitlefont\MakeUppercase{\soChapter{##1}}%
      \par\nobreak\vskip 7pt%
      \chapsubtitlefont\@vaggaName%
    \global\def\@vaggaName{}%
  }
}

\chapterstyle{default}

%% ==============
%% Section styles
%% ==============

\DeclareDocumentCommand\Section{oom}{
\IfNoValueTF{#1}
  {\section[#3]{\MakeUppercase{\soSection{#3}}}}
  {\IfNoValueTF{#2}{\section[#1]{\MakeUppercase{\soSection{#3}}}}{\section[#1][#2]{\MakeUppercase{\soSection{#3}}}}}
}

\setbeforesecskip{-3.5ex \@plus -1ex \@minus -.2ex}
\setaftersecskip{2.5ex \@plus .2ex}

\setsecheadstyle{\sectionFont\sectiontitlesize\color{chaptitle}}
\setsubsecheadstyle{\sectionFont\large\itshape\memRTLraggedright}
\setsubsubsecheadstyle{\sectionFont\normalsize\itshape\memRTLraggedright}

%% ==========================
%% Packages to be loaded LAST
%% ==========================

\usepackage[perpage,multiple,stable]{footmisc}

\usepackage[final,babel=true]{microtype}

%% =================
%% PDF/X-3:2002 info
%% =================

% \pdfobjcompresslevel=0%
% \pdfminorversion=3%
% \pdfinfo{
%   /Title (Dhammapada)
%   /Author (Forizs Laszlo)
%   /Subject (buddhizmus)
%   /Keywords (buddhizmus)
%   /GTS_PDFXVersion (PDF/X-3:2002)
% }%
% \pdfpageattr{
% /MediaBox [0 0 369.00000 594.00000]
% /BleedBox [0.00000 0.00000 369.00000 594.00000]
% /CropBox [0 0 369.00000 594.00000]
% /TrimBox [0.00000 0.00000 369.00000 594.00000]
% }
% \pdfcatalog{
%   /PageMode /UseNone
%   /OutputIntents [ <<
%     /Info (none)
%     /Type /OutputIntent
%     /S /GTS_PDFX
%     /OutputConditionIdentifier (Blurb.com)
%     /RegistryName (http://www.color.org/)
%   >> ]
% }%

%% ==============
